<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è³¼ç‰©è¨ˆç®—æ©Ÿ v24 (ç©©å®šæ¥µé€Ÿç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- æ ¸å¿ƒå‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        body { touch-action: manipulation; font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        #reader video { object-fit: cover; border-radius: 12px; }
        #exportReceipt { position: fixed; top: -9999px; left: 0; width: 500px; background: white; padding: 20px; color: #1e293b; z-index: -1; }
        [contenteditable="true"] { border-bottom: 1px dashed #cbd5e1; padding: 0 2px; }
        [contenteditable="true"]:focus { outline: none; background-color: #eff6ff; border-bottom: 2px solid #3b82f6; border-radius: 4px; color: #1e40af; }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, -20px); opacity: 1; } }
        .toast-show { display: block !important; animation: slideUp 0.3s forwards; }
        .btn-close { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background-color: #f1f5f9; color: #64748b; }
        .btn-close:hover { background-color: #fee2e2; color: #ef4444; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24 text-slate-800">

    <!-- é ‚éƒ¨å°èˆª -->
    <div class="sticky top-0 z-30 bg-blue-600 text-white shadow-lg rounded-b-2xl transition-all">
        <div class="max-w-md mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <div class="flex flex-col">
                    <h1 class="text-sm font-bold tracking-wide flex items-center gap-2">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                        è³¼ç‰©è¨ˆç®—æ©Ÿ Pro
                    </h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="statusBadge" class="text-[10px] bg-blue-800 px-1.5 py-0.5 rounded opacity-80">æº–å‚™ä¸­...</span>
                        <span id="userBadge" class="text-[10px] bg-indigo-500 px-1.5 py-0.5 rounded hidden font-mono"></span>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="btnDb" class="p-2 bg-indigo-500 hover:bg-indigo-600 rounded-lg shadow-sm transition-colors" title="å…¬å…±åº«å­˜"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><database cx="12" cy="12" r="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg></button>
                    <button id="btnSettings" class="p-2 bg-blue-700 hover:bg-blue-800 rounded-lg border border-blue-500/30 transition-colors" title="è¨­å®š"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
                    <button id="btnExport" class="p-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg border border-emerald-500/30 transition-colors" title="åŒ¯å‡º/å‚™ä»½"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                    <button id="btnClear" class="p-2 bg-red-500 hover:bg-red-600 rounded-lg border border-red-400/30 transition-colors" title="æ¸…ç©º"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
            </div>

            <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm border border-white/10">
                <div class="flex flex-col items-center justify-center">
                    <div class="flex items-baseline gap-1.5">
                        <span id="lblBase" class="text-sm font-medium opacity-80">JPY</span>
                        <span id="dispTotal" class="text-4xl font-bold tracking-tight">0</span>
                    </div>
                    <div class="text-blue-100 text-sm font-medium bg-blue-800/40 px-3 py-1 rounded-full mt-1 flex items-center gap-2 border border-blue-400/20">
                        <span>â‰ˆ</span><span id="dispConverted">$0</span><span id="lblTarget">TWD</span>
                        <span class="text-[10px] opacity-60 ml-1 border-l border-white/20 pl-2">åŒ¯ç‡: <span id="dispRate">--</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="max-w-md mx-auto px-3 mt-4 pb-10">
        <div class="bg-white rounded-2xl shadow-sm p-3 mb-4 border border-slate-200 sticky top-[10px] z-20">
            <form id="formItem" class="flex flex-col gap-2">
                <div class="flex gap-2">
                    <button type="button" id="btnScan" class="bg-slate-100 text-slate-600 px-3 rounded-xl border border-slate-200 hover:bg-slate-200 transition-colors flex items-center justify-center">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="10" x="7" y="7" rx="1"/></svg>
                    </button>
                    <div class="flex-1 relative">
                        <input type="text" id="inpName" placeholder="å“å (æˆ–æƒæ)" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-3 pr-2 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    </div>
                    <div class="w-1/3 min-w-[90px]">
                        <input type="number" id="inpPrice" inputmode="decimal" placeholder="åƒ¹æ ¼" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-2 py-3 text-right text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    </div>
                </div>
                <div id="scanHint" class="hidden text-xs px-2 flex justify-between items-center bg-green-50 p-2 rounded-lg border border-green-100 text-green-700">
                    <div class="flex items-center gap-2"><span class="bg-green-200 text-green-800 px-1.5 rounded text-[10px] font-bold">å·²æƒæ</span><span id="lblSource" class="font-bold">--</span></div>
                    <button type="button" id="btnClearScan" class="text-slate-400 hover:text-red-500 px-2 font-bold">âœ•</button>
                </div>
                <button type="submit" class="w-full py-3 rounded-xl font-bold text-white text-sm bg-blue-600 shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all flex justify-center items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>åŠ å…¥è³¼ç‰©æ¸…å–®
                </button>
            </form>
        </div>
        <div id="listContainer" class="space-y-2"></div>
        <div id="emptyState" class="hidden flex-col items-center py-12 text-slate-300">
            <svg class="w-16 h-16 mb-3 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
            <p class="font-medium">è³¼ç‰©æ¸…å–®æ˜¯ç©ºçš„</p>
        </div>
    </div>

    <!-- Modals -->
    <div id="modalSettings" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">è¨­å®š</h3><button onclick="document.getElementById('modalSettings').classList.add('hidden')" class="btn-close">âœ•</button>
            </div>
            <div class="p-5 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">æ¶ˆè²»å¹£åˆ¥</label><select id="selBase" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm outline-none"></select></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">æ›ç®—å¹£åˆ¥</label><select id="selTarget" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm outline-none"></select></div>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <label class="block text-xs font-bold text-slate-400 mb-1">åŒ¯ç‡ (1 <span id="lblBaseSet"></span> = ? <span id="lblTargetSet"></span>)</label>
                    <div class="flex gap-2"><input type="number" id="inpRate" step="0.0001" class="flex-1 border rounded-lg p-2 text-sm"><button id="btnFetchRate" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-bold">æ›´æ–°</button></div>
                </div>
                <div class="pt-2 border-t border-slate-100">
                    <div id="loginSection"><button id="btnLoginGoogle" class="w-full py-2.5 bg-white border rounded-lg text-sm font-bold flex items-center justify-center gap-2">Google ç™»å…¥</button></div>
                    <div id="userInfoSection" class="hidden text-center"><p class="text-sm font-bold" id="userEmailDisplay"></p><button id="btnLogout" class="text-xs text-red-500 mt-2">ç™»å‡º</button></div>
                </div>
                <button onclick="document.getElementById('modalSettings').classList.add('hidden')" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold mt-2">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div id="modalExport" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-xl flex flex-col max-h-[85vh]">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-lg">åŒ¯å‡ºèˆ‡å‚™ä»½</h3><button onclick="document.getElementById('modalExport').classList.add('hidden')" class="btn-close">âœ•</button></div>
            <div class="p-5 pb-0 space-y-3">
                <div class="flex justify-between p-3 border rounded-xl hover:bg-slate-50"><span>ğŸ–¼ï¸ åœ–ç‰‡</span><div class="flex gap-2"><button onclick="doExport('png')" class="px-3 bg-slate-100 rounded text-xs font-bold">å„²å­˜</button><button onclick="doShareFile('png')" class="px-3 bg-blue-100 text-blue-700 rounded text-xs font-bold">åˆ†äº«</button></div></div>
                <div class="flex justify-between p-3 border rounded-xl hover:bg-slate-50"><span>ğŸ“Š Excel</span><div class="flex gap-2"><button onclick="doExport('xlsx')" class="px-3 bg-slate-100 rounded text-xs font-bold">å„²å­˜</button><button onclick="doShareFile('xlsx')" class="px-3 bg-green-100 text-green-700 rounded text-xs font-bold">åˆ†äº«</button></div></div>
                <div class="flex justify-between p-3 border rounded-xl hover:bg-slate-50"><span>ğŸ“„ PDF</span><div class="flex gap-2"><button onclick="doExport('pdf')" class="px-3 bg-slate-100 rounded text-xs font-bold">å„²å­˜</button><button onclick="doShareFile('pdf')" class="px-3 bg-red-100 text-red-700 rounded text-xs font-bold">åˆ†äº«</button></div></div>
                <button onclick="doShareText()" class="w-full p-3 border rounded-xl hover:bg-blue-50 text-blue-700 font-bold text-sm">è¤‡è£½/åˆ†äº«æ–‡å­—</button>
                <div class="border-t border-slate-100 pt-3 flex justify-between"><span class="text-xs font-bold text-slate-500">é›²ç«¯å‚™ä»½</span><button onclick="createBackup()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">+ ç«‹å³å‚™ä»½</button></div>
            </div>
            <div class="overflow-y-auto flex-1 px-5 pb-5 space-y-2 mt-2" id="backupListContainer"></div>
        </div>
    </div>

    <div id="modalDb" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm h-[80vh] flex flex-col shadow-2xl">
            <div class="p-4 border-b border-gray-100 flex flex-col gap-2 bg-indigo-600 text-white rounded-t-2xl">
                <div class="flex justify-between items-center"><h3 class="font-bold">å…¬å…±å•†å“åº«å­˜</h3><button onclick="document.getElementById('modalDb').classList.add('hidden')" class="text-white/80 hover:text-white">âœ•</button></div>
                <input type="text" id="inpDbSearch" placeholder="ğŸ” æœå°‹..." class="w-full px-3 py-2 text-sm text-slate-800 rounded-lg focus:outline-none" oninput="filterDbList(this.value)">
            </div>
            <div class="p-2 bg-indigo-50 text-indigo-800 text-xs font-bold text-center border-b border-indigo-100" id="adminNotice"></div>
            <div class="p-4 overflow-y-auto flex-1 space-y-2" id="dbListContainer"></div>
        </div>
    </div>

    <div id="modalScan" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <button id="btnCloseScan" class="absolute top-4 right-4 bg-white/20 p-2 rounded-full text-white">âœ•</button>
        <div class="text-white mb-4 text-lg font-bold">æƒææ¢ç¢¼</div><div id="reader" class="w-full max-w-sm bg-black rounded-xl overflow-hidden"></div>
    </div>

    <div id="modalConfirm" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 id="confirmTitle" class="text-xl font-bold text-center mb-2"></h3><p id="confirmMsg" class="text-sm text-center mb-6"></p><div class="grid grid-cols-2 gap-3"><button id="btnConfirmCancel" class="py-3 bg-slate-100 rounded-xl font-bold">å–æ¶ˆ</button><button id="btnConfirmOk" class="py-3 bg-red-600 text-white rounded-xl font-bold">ç¢ºå®š</button></div></div>
    </div>
    <div id="toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-[70]"></div>
    <div id="exportReceipt"></div>

    <script>
        const ADMIN_EMAIL = 'jingsyuan@gmail.com';
        const CURRENCIES = { 'TWD': 'æ–°å°å¹£', 'JPY': 'æ—¥åœ“', 'USD': 'ç¾é‡‘', 'EUR': 'æ­å…ƒ', 'KRW': 'éŸ“å…ƒ', 'CNY': 'äººæ°‘å¹£', 'HKD': 'æ¸¯å¹£', 'THB': 'æ³°éŠ–', 'SGD': 'æ–°å¹£', 'MYR': 'é¦¬å¹£' };
        
        const firebaseConfig = {
            apiKey: "AIzaSyBCpjQ9W336gYM8fPtZPcy2I5tceEQrsBA",
            authDomain: "shopping-ceef3.firebaseapp.com",
            projectId: "shopping-ceef3",
            storageBucket: "shopping-ceef3.firebasestorage.app",
            messagingSenderId: "928963463458",
            appId: "1:928963463458:web:001d86393d780db851fd7b",
            measurementId: "G-KR9GS69ZPN"
        };

        let dbMode = 'local', currentUser = null, currentBarcode = null, items = [], onConfirmAction = null, isProcessingScan = false;
        let settings = JSON.parse(localStorage.getItem('exSettings')) || { base: 'JPY', target: 'TWD', rate: 0.215 };
        let html5QrCode = null;

        // --- Core Init ---
        (async function init() {
            initCurrencySelects(); updateSettingsUI(); bindEvents();
            
            try {
                // 1. å¦‚æœ Firebase å·²ç¶“å­˜åœ¨ (ç†±é‡è¼‰æƒ…æ³)ï¼Œç›´æ¥ä½¿ç”¨
                if (firebase.apps.length > 0) {
                    firebase.app(); // Reuse
                } else {
                    firebase.initializeApp(firebaseConfig); // New init
                }
                
                // 2. ç›£è½ Auth
                firebase.auth().onAuthStateChanged(user => {
                    if (user) handleLoginSuccess(user);
                    else firebase.auth().signInAnonymously().catch(e => activateLocalMode('ç™»å…¥å¤±æ•—'));
                });

            } catch (e) {
                console.log("Fallback to Local:", e);
                activateLocalMode('è¨­å®š/é€£ç·šéŒ¯èª¤');
            }
        })();

        function activateLocalMode(reason) {
            dbMode = 'local';
            document.getElementById('statusBadge').textContent = `ğŸŸ  æœ¬æ©Ÿ (${reason})`;
            document.getElementById('statusBadge').className = 'text-[10px] bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded opacity-80';
            items = JSON.parse(localStorage.getItem('localItems')) || [];
            renderList();
        }

        function handleLoginSuccess(user) {
            currentUser = user; dbMode = 'cloud';
            document.getElementById('statusBadge').textContent = 'ğŸŸ¢ é›²ç«¯';
            document.getElementById('statusBadge').className = 'text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded opacity-80';
            document.getElementById('userBadge').classList.remove('hidden');
            
            const isAdmin = user.email === ADMIN_EMAIL;
            const badge = document.getElementById('userBadge');
            if (isAdmin) { badge.textContent = "ç®¡ç†è€…"; badge.className = "text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold border border-red-200"; }
            else if (user.isAnonymous) { badge.textContent = `è¨ªå®¢(${user.uid.slice(0,3)})`; badge.className = "text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded"; }
            else { badge.textContent = "å·²ç™»å…¥"; badge.className = "text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded"; }

            document.getElementById('loginSection').classList.toggle('hidden', !user.isAnonymous);
            document.getElementById('userInfoSection').classList.toggle('hidden', user.isAnonymous);
            if(!user.isAnonymous) document.getElementById('userEmailDisplay').textContent = user.email;

            firebase.firestore().collection('users').doc(user.uid).collection('shopping_list').orderBy('timestamp', 'desc').onSnapshot(snap => {
                items = snap.docs.map(d => ({ ...d.data(), id: d.id })); renderList();
            }, err => activateLocalMode('åŒæ­¥ä¸­æ–·'));
        }

        // --- Logic ---
        function bindEvents() {
            const els = {
                btnSettings: document.getElementById('btnSettings'),
                btnExport: document.getElementById('btnExport'),
                btnDb: document.getElementById('btnDb'),
                btnClear: document.getElementById('btnClear'),
                btnScan: document.getElementById('btnScan'),
                form: document.getElementById('formItem')
            };

            els.btnSettings.onclick = () => document.getElementById('modalSettings').classList.remove('hidden');
            els.btnExport.onclick = () => { document.getElementById('modalExport').classList.remove('hidden'); if(dbMode==='cloud') loadBackups(); };
            els.btnDb.onclick = openDbManager;
            els.btnClear.onclick = () => showConfirm("æ¸…ç©º", "ç¢ºå®šç§»é™¤æ‰€æœ‰é …ç›®ï¼Ÿ", async () => {
                if(dbMode==='cloud') {
                    const b = firebase.firestore().batch();
                    const s = await firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list').get();
                    s.docs.forEach(d => b.delete(d.ref));
                    await b.commit();
                } else {
                    items = []; localStorage.setItem('localItems', '[]'); renderList();
                }
                showToast("å·²æ¸…ç©º");
            });

            els.form.onsubmit = async (e) => {
                e.preventDefault();
                const n = document.getElementById('inpName').value.trim(); const p = parseFloat(document.getElementById('inpPrice').value);
                if(!p && p!==0) return;
                const item = { name: n||'(æœªå‘½å)', price: p, barcode: currentBarcode, timestamp: Date.now() };
                
                if(dbMode==='cloud') {
                    await firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list').add({ ...item, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    if(currentBarcode && n) firebase.firestore().collection('products').doc(currentBarcode).set({ name: n, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), contributor: currentUser.uid }, {merge:true});
                } else {
                    item.id = Date.now().toString(); items.unshift(item); localStorage.setItem('localItems', JSON.stringify(items)); renderList();
                }
                document.getElementById('inpName').value=''; document.getElementById('inpPrice').value=''; 
                currentBarcode=null; document.getElementById('scanHint').classList.add('hidden'); showToast("å·²åŠ å…¥");
            };

            // Login/Logout
            document.getElementById('btnLoginGoogle').onclick = async () => { try{ await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()); showToast("æˆåŠŸ"); }catch(e){alert(e.message);} };
            document.getElementById('btnLogout').onclick = () => firebase.auth().signOut().then(()=>window.location.reload());

            // Scan
            document.getElementById('btnScan').onclick = () => { 
                document.getElementById('modalScan').classList.remove('hidden'); 
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async txt => {
                    if(isProcessingScan) return; isProcessingScan = true;
                    try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e){}
                    document.getElementById('modalScan').classList.add('hidden');
                    currentBarcode = txt; 
                    document.getElementById('inpName').value = "æŸ¥è©¢ä¸­..."; 
                    document.getElementById('scanHint').classList.remove('hidden'); 
                    document.getElementById('lblSource').textContent = "...";
                    
                    let name="", src="æ–°ç™¼ç¾";
                    try {
                        if(dbMode==='cloud') { const d=await firebase.firestore().collection('products').doc(txt).get(); if(d.exists){ name=d.data().name; src="è³‡æ–™åº«"; } }
                        if(!name) { const r=await fetch(`https://world.openfoodfacts.org/api/v0/product/${txt}.json`); const d=await r.json(); if(d.status===1) { name=d.product.product_name_zh||d.product.product_name; src="ç¶²è·¯ API"; } }
                    } catch(e){}
                    
                    document.getElementById('inpName').value=name; document.getElementById('inpName').focus(); document.getElementById('lblSource').textContent=src;
                    setTimeout(() => isProcessingScan = false, 1000);
                }).catch(()=>{}); 
            };
            document.getElementById('btnCloseScan').onclick = () => { if(html5QrCode) html5QrCode.stop().then(()=>html5QrCode.clear()).catch(()=>{}); document.getElementById('modalScan').classList.add('hidden'); };
            document.getElementById('btnClearScan').onclick = () => { currentBarcode=null; document.getElementById('scanHint').classList.add('hidden'); document.getElementById('inpName').value=''; };

            // Modals Close
            document.getElementById('btnConfirmCancel').onclick = () => { document.getElementById('modalConfirm').classList.add('hidden'); onConfirmAction=null; };
            document.getElementById('btnConfirmOk').onclick = () => { if(onConfirmAction) onConfirmAction(); document.getElementById('modalConfirm').classList.add('hidden'); onConfirmAction=null; };

            // Content Editable
            document.getElementById('listContainer').addEventListener('focusout', async (e) => {
                const el = e.target;
                if(!el.hasAttribute('contenteditable')) return;
                const id = el.dataset.id, field = el.dataset.field;
                let val = el.textContent.trim();
                if(field==='price') val = parseFloat(val.replace(/,/g,''))||0;
                
                if(dbMode==='cloud') await firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list').doc(id).update({[field]:val});
                else { const i=items.find(x=>x.id===id); if(i){ i[field]=val; localStorage.setItem('localItems', JSON.stringify(items)); renderList(); } }
            });
            document.getElementById('listContainer').addEventListener('keydown', e => { if(e.target.hasAttribute('contenteditable') && e.key==='Enter'){ e.preventDefault(); e.target.blur(); } });

            // Settings
            ['selBase', 'selTarget'].forEach(id => document.getElementById(id).onchange = () => {
                settings.base = document.getElementById('selBase').value; settings.target = document.getElementById('selTarget').value;
                localStorage.setItem('exSettings', JSON.stringify(settings)); updateSettingsUI(); document.getElementById('btnFetchRate').click();
            });
            document.getElementById('inpRate').oninput = (e) => { settings.rate = parseFloat(e.target.value)||0; localStorage.setItem('exSettings', JSON.stringify(settings)); renderList(); };
            document.getElementById('btnFetchRate').onclick = async () => {
                const btn=document.getElementById('btnFetchRate'); btn.textContent="...";
                try { const res=await fetch(`https://api.exchangerate-api.com/v4/latest/${settings.base}`); const d=await res.json(); if(d.rates[settings.target]){ settings.rate=d.rates[settings.target]; localStorage.setItem('exSettings', JSON.stringify(settings)); updateSettingsUI(); showToast("æ›´æ–°æˆåŠŸ"); } } catch(e){ showToast("é€£ç·šå¤±æ•—"); } btn.textContent="ç·šä¸Šæ›´æ–°";
            };
        }

        // --- Backup & Export ---
        async function createBackup() {
            if(dbMode!=='cloud' || !currentUser) return alert("éœ€ç™»å…¥");
            const dateStr = new Date().toISOString().replace(/[:.]/g,'-');
            try {
                await firebase.firestore().collection('users').doc(currentUser.uid).collection('backups').doc(dateStr).set({
                    items: items, createdAt: firebase.firestore.FieldValue.serverTimestamp(), displayName: new Date().toLocaleString()
                });
                showToast("å‚™ä»½æˆåŠŸ"); loadBackups();
            } catch(e) { alert("å‚™ä»½å¤±æ•—: "+e.message); }
        }
        async function loadBackups() {
            const c = document.getElementById('backupListContainer'); c.innerHTML='<div class="text-center py-4 text-xs text-slate-400">è¼‰å…¥ä¸­...</div>';
            try {
                const s = await firebase.firestore().collection('users').doc(currentUser.uid).collection('backups').orderBy('createdAt','desc').limit(10).get();
                c.innerHTML = s.empty ? '<div class="text-center py-4 text-xs text-slate-400">ç„¡å‚™ä»½</div>' : s.docs.map(d => 
                    `<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100 mb-2">
                        <div><div class="text-sm font-bold text-slate-700">${d.data().displayName}</div><div class="text-[10px] text-slate-400">${(d.data().items||[]).length} é …ç›®</div></div>
                        <button onclick="restoreBackup('${d.id}')" class="text-xs bg-white border border-slate-200 text-blue-600 px-3 py-1.5 rounded font-bold">é‚„åŸ</button>
                    </div>`).join('');
            } catch(e) { c.innerHTML='<div class="text-center text-red-400">å¤±æ•—</div>'; }
        }
        window.restoreBackup = (id) => showConfirm("é‚„åŸ", "è¦†è“‹ç•¶å‰æ¸…å–®ï¼Ÿ", async () => {
            try {
                const d = await firebase.firestore().collection('users').doc(currentUser.uid).collection('backups').doc(id).get();
                if(!d.exists) return;
                const b = firebase.firestore().batch();
                const r = firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list');
                const s = await r.get(); s.docs.forEach(x=>b.delete(x.ref));
                (d.data().items||[]).forEach(i => { const {id,...rest}=i; b.set(r.doc(), rest); });
                await b.commit(); showToast("é‚„åŸæˆåŠŸ"); document.getElementById('modalExport').classList.add('hidden');
            } catch(e) { alert("å¤±æ•—: "+e.message); }
        });

        // --- Render ---
        function renderList() {
            const total = items.reduce((s,i)=>s+(i.price||0),0);
            document.getElementById('dispTotal').textContent=total.toLocaleString();
            document.getElementById('dispConverted').textContent='$'+Math.round(total*settings.rate).toLocaleString();
            document.getElementById('dispRate').textContent=settings.rate;
            const html = items.map(i=>`
                <div class="flex items-center justify-between px-4 py-3 bg-white rounded-xl border border-slate-100 shadow-sm mb-2">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <div class="flex flex-col items-end min-w-[60px]"><div class="text-lg font-bold text-slate-800" contenteditable="true" data-id="${i.id}" data-field="price">${i.price.toLocaleString()}</div><div class="text-[11px] text-slate-400">â‰ˆ ${Math.round(i.price*settings.rate).toLocaleString()}</div></div>
                        <div class="h-8 w-px bg-slate-100"></div>
                        <div class="flex-1 overflow-hidden"><div class="text-sm font-medium text-slate-700 truncate" contenteditable="true" data-id="${i.id}" data-field="name">${i.name}</div>${i.barcode?`<div class="text-[10px] font-mono text-slate-400 bg-slate-50 inline-block px-1.5 py-0.5 rounded border border-slate-100 mt-0.5">${i.barcode}</div>`:''}</div>
                    </div>
                    <button onclick="deleteItem('${i.id}')" class="ml-2 text-slate-300 hover:text-red-500 p-2">âœ•</button>
                </div>`).join('');
            document.getElementById('listContainer').innerHTML = html;
            document.getElementById('emptyState').style.display = items.length===0?'flex':'none';
            prepareReceipt();
        }

        // --- Shared Utils ---
        function showToast(msg) { const e=document.getElementById('toast'); e.textContent=msg; e.classList.add('toast-show'); setTimeout(()=>e.classList.remove('toast-show'),2500); }
        function showConfirm(t,m,cb) { document.getElementById('confirmTitle').textContent=t; document.getElementById('confirmMsg').textContent=m; document.getElementById('modalConfirm').classList.remove('hidden'); onConfirmAction=cb; }
        window.deleteItem = (id) => showConfirm("åˆªé™¤", "ç¢ºå®šç§»é™¤ï¼Ÿ", async () => {
            if(dbMode==='cloud') await firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list').doc(id).delete();
            else { items=items.filter(x=>x.id!==id); localStorage.setItem('localItems', JSON.stringify(items)); renderList(); }
            showToast("å·²åˆªé™¤");
        });
        function initCurrencySelects() { const o=Object.entries(CURRENCIES).map(([k,v])=>`<option value="${k}">${v}</option>`).join(''); document.getElementById('selBase').innerHTML=o; document.getElementById('selTarget').innerHTML=o; }
        function updateSettingsUI() { document.getElementById('selBase').value=settings.base; document.getElementById('selTarget').value=settings.target; document.getElementById('inpRate').value=settings.rate; document.getElementById('lblBase').textContent=settings.base; document.getElementById('lblTarget').textContent=settings.target; document.getElementById('lblBaseSet').textContent=settings.base; document.getElementById('lblTargetSet').textContent=settings.target; document.getElementById('inpPrice').placeholder=`åƒ¹æ ¼ (${settings.base})`; renderList(); }
        
        async function openDbManager() {
            document.getElementById('modalDb').classList.remove('hidden');
            const c = document.getElementById('dbListContainer');
            if(dbMode!=='cloud') return c.innerHTML='<div class="text-center py-10 text-slate-400">éœ€é€£ç·š</div>';
            c.innerHTML='<div class="text-center py-10 text-slate-400">è¼‰å…¥ä¸­...</div>';
            const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
            document.getElementById('adminNotice').textContent = isAdmin ? "ğŸ‘‘ ç®¡ç†å“¡" : "ğŸ‘€ è¨ªå®¢ (å”¯è®€)";
            try {
                const s = await firebase.firestore().collection('products').orderBy('updatedAt', 'desc').limit(50).get();
                c.innerHTML = s.empty ? '<div class="text-center py-10 text-slate-400">ç©º</div>' : s.docs.map(d => 
                    `<div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 mb-2">
                        <div class="overflow-hidden mr-3"><div class="font-bold text-sm text-slate-700 truncate">${d.data().name}</div><div class="text-[10px] font-mono text-indigo-400">${d.id}</div></div>
                        ${isAdmin ? `<button onclick="delPub('${d.id}')" class="text-red-500 text-xs border border-red-200 p-1 rounded">åˆª</button>` : ''}
                    </div>`).join('');
            } catch(e) { c.innerHTML='<div class="text-center text-red-400">å¤±æ•—</div>'; }
        }
        window.filterDbList = (v) => { const t=v.toLowerCase(); document.querySelectorAll('#dbListContainer > div').forEach(r => r.style.display = r.innerText.toLowerCase().includes(t)?'flex':'none'); };
        window.delPub = (id) => showConfirm("åˆªé™¤", "ç¢ºå®šåˆªé™¤æ­¤å…¬å…±æ¢ç¢¼ï¼Ÿ", async () => { await firebase.firestore().collection('products').doc(id).delete(); openDbManager(); showToast("å·²åˆªé™¤"); });

        function prepareReceipt() {
            document.getElementById('receiptDate').textContent = new Date().toLocaleString();
            document.getElementById('receiptTotalBase').textContent = document.getElementById('dispTotal').textContent;
            document.getElementById('receiptTotalTarget').textContent = document.getElementById('dispConverted').textContent;
            document.getElementById('receiptItems').innerHTML = items.map(i => `<tr><td style="padding:5px">${i.name}</td><td style="text-align:right">${i.price}</td><td style="text-align:right">${Math.round(i.price * settings.rate)}</td></tr>`).join('');
        }
        async function doExport(type) {
            prepareReceipt();
            const el = document.getElementById('exportReceipt');
            const fname = `List_${new Date().toISOString().slice(0,10)}`;
            try {
                if(type==='png') { const c=await html2canvas(el,{scale:2}); const a=document.createElement('a'); a.href=c.toDataURL(); a.download=fname+'.png'; a.click(); }
                else if(type==='xlsx') { const ws=XLSX.utils.json_to_sheet(items.map(i=>({'å“å':i.name,'åƒ¹æ ¼':i.price,'ç´„':Math.round(i.price*settings.rate)}))); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"æ¸…å–®"); XLSX.writeFile(wb,fname+'.xlsx'); }
                else if(type==='pdf') { const c=await html2canvas(el,{scale:2}); const p=new window.jspdf.jsPDF(); const img=c.toDataURL('image/png'); const props=p.getImageProperties(img); const h=(props.height*p.internal.pageSize.getWidth())/props.width; p.addImage(img,'PNG',0,10,p.internal.pageSize.getWidth(),h); p.save(fname+'.pdf'); }
            } catch(e){ alert("åŒ¯å‡ºå¤±æ•—"); }
        }
        async function doShareFile(type) {
            prepareReceipt(); const el = document.getElementById('exportReceipt'); const fname = `List_${new Date().toISOString().slice(0,10)}`;
            try {
                let blob;
                if(type==='png') { const c=await html2canvas(el,{scale:2}); blob=await new Promise(r=>c.toBlob(r)); }
                else if(type==='xlsx') { const ws=XLSX.utils.json_to_sheet(items.map(i=>({'å“å':i.name,'åƒ¹æ ¼':i.price,'ç´„':Math.round(i.price*settings.rate)}))); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"æ¸…å–®"); const out=XLSX.write(wb,{bookType:'xlsx',type:'array'}); blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); }
                else if(type==='pdf') { const c=await html2canvas(el,{scale:2}); const p=new window.jspdf.jsPDF(); const img=c.toDataURL('image/png'); const props=p.getImageProperties(img); const h=(props.height*p.internal.pageSize.getWidth())/props.width; p.addImage(img,'PNG',0,10,p.internal.pageSize.getWidth(),h); blob=p.output('blob'); }
                
                const f = new File([blob], fname + (type==='png'?'.png':(type==='xlsx'?'.xlsx':'.pdf')), {type: blob.type});
                if(navigator.canShare && navigator.canShare({files:[f]})) await navigator.share({files:[f], title:'è³¼ç‰©æ¸…å–®'}); else doExport(type);
            } catch(e) { alert("åˆ†äº«å¤±æ•—"); }
        }
        function doShareText() {
            if(!items.length) return alert("ç©ºæ¸…å–®");
            let t = `ğŸ›’ è³¼ç‰©æ¸…å–® (${new Date().toLocaleDateString()})\n\n`;
            items.forEach(i => t += `â–«ï¸ ${i.name}: ${i.price}\n`);
            t += `\nğŸ’° ç¸½è¨ˆ: ${document.getElementById('dispTotal').textContent} ${settings.base}`;
            if(navigator.share) navigator.share({title:'è³¼ç‰©æ¸…å–®',text:t}).catch(()=>{}); else { navigator.clipboard.writeText(t); showToast("å·²è¤‡è£½"); }
        }
    </script>
</body>
</html>
