<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è³¼ç‰©è¨ˆç®—æ©Ÿ v21 (è¨ªå®¢ä¿å­˜å„ªåŒ–ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- æ ¸å¿ƒå‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        body { touch-action: manipulation; font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        #reader video { object-fit: cover; border-radius: 12px; }
        
        /* éš±è—çš„æ”¶æ“šæ¨£å¼ (ç¢ºä¿æˆªåœ–æ¸…æ™°) */
        #exportReceipt { position: fixed; top: -9999px; left: 0; width: 500px; background: white; padding: 20px; color: #1e293b; z-index: -1; }
        
        /* å¯ç·¨è¼¯æ¬„ä½ */
        [contenteditable="true"] { border-bottom: 1px dashed #cbd5e1; transition: all 0.2s; padding: 0 2px; }
        [contenteditable="true"]:focus { outline: none; background-color: #eff6ff; border-bottom: 2px solid #3b82f6; border-radius: 4px; color: #1e40af; }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, -20px); opacity: 1; } }
        .toast-show { display: block !important; animation: slideUp 0.3s forwards; }
        .modal-enter { animation: modalIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .btn-close {
            display: flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; border-radius: 50%;
            background-color: #f1f5f9; color: #64748b; transition: all 0.2s;
        }
        .btn-close:hover { background-color: #fee2e2; color: #ef4444; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24 text-slate-800">

    <!-- é ‚éƒ¨å°èˆª -->
    <div class="sticky top-0 z-30 bg-blue-600 text-white shadow-lg rounded-b-2xl transition-all">
        <div class="max-w-md mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <div class="flex flex-col">
                    <h1 class="text-sm font-bold tracking-wide flex items-center gap-2">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                        è³¼ç‰©è¨ˆç®—æ©Ÿ Pro
                    </h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="statusBadge" class="text-[10px] bg-blue-800 px-1.5 py-0.5 rounded opacity-80">åˆå§‹åŒ–...</span>
                        <!-- é€™è£¡æœƒé¡¯ç¤ºèº«ä»½ -->
                        <span id="userBadge" class="text-[10px] bg-indigo-500 px-1.5 py-0.5 rounded hidden font-mono"></span>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="btnDb" class="p-2 bg-indigo-500 hover:bg-indigo-600 rounded-lg shadow-sm transition-colors" title="å…¬å…±åº«å­˜">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><database cx="12" cy="12" r="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                    </button>
                    <button id="btnSettings" class="p-2 bg-blue-700 hover:bg-blue-800 rounded-lg border border-blue-500/30 transition-colors" title="è¨­å®š">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </button>
                    <button id="btnExport" class="p-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg border border-emerald-500/30 transition-colors" title="åŒ¯å‡º/å‚™ä»½">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </button>
                    <button id="btnClear" class="p-2 bg-red-500 hover:bg-red-600 rounded-lg border border-red-400/30 transition-colors" title="æ¸…ç©º">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                </div>
            </div>

            <!-- é‡‘é¡é¡¯ç¤ºé¢æ¿ -->
            <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm border border-white/10">
                <div class="flex flex-col items-center justify-center">
                    <div class="flex items-baseline gap-1.5">
                        <span id="lblBase" class="text-sm font-medium opacity-80">JPY</span>
                        <span id="dispTotal" class="text-4xl font-bold tracking-tight">0</span>
                    </div>
                    <div class="text-blue-100 text-sm font-medium bg-blue-800/40 px-3 py-1 rounded-full mt-1 flex items-center gap-2 border border-blue-400/20">
                        <span>â‰ˆ</span><span id="dispConverted">$0</span><span id="lblTarget">TWD</span>
                        <span class="text-[10px] opacity-60 ml-1 border-l border-white/20 pl-2">åŒ¯ç‡: <span id="dispRate">--</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="max-w-md mx-auto px-3 mt-4 pb-10">
        <!-- è¼¸å…¥èˆ‡æƒæå€ -->
        <div class="bg-white rounded-2xl shadow-sm p-3 mb-4 border border-slate-200 sticky top-[10px] z-20">
            <form id="formItem" class="flex flex-col gap-2">
                <div class="flex gap-2">
                    <button type="button" id="btnScan" class="bg-slate-100 text-slate-600 px-3 rounded-xl border border-slate-200 hover:bg-slate-200 transition-colors flex items-center justify-center">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="10" x="7" y="7" rx="1"/></svg>
                    </button>
                    <div class="flex-1 relative">
                        <input type="text" id="inpName" placeholder="å“å (æˆ–æƒæ)" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-3 pr-2 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    </div>
                    <div class="w-1/3 min-w-[90px]">
                        <input type="number" id="inpPrice" inputmode="decimal" placeholder="åƒ¹æ ¼" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-2 py-3 text-right text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    </div>
                </div>
                
                <!-- æƒæçµæœæç¤º -->
                <div id="scanHint" class="hidden text-xs px-2 flex justify-between items-center bg-green-50 p-2 rounded-lg border border-green-100 text-green-700 animate-pulse-once">
                    <div class="flex items-center gap-2">
                        <span class="bg-green-200 text-green-800 px-1.5 rounded text-[10px] font-bold">å·²æƒæ</span>
                        <span id="lblSource" class="font-bold">--</span>
                    </div>
                    <button type="button" id="btnClearScan" class="text-slate-400 hover:text-red-500 px-2 font-bold">âœ•</button>
                </div>

                <button type="submit" class="w-full py-3 rounded-xl font-bold text-white text-sm bg-blue-600 shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all flex justify-center items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    åŠ å…¥è³¼ç‰©æ¸…å–®
                </button>
            </form>
        </div>

        <!-- æ¸…å–®åˆ—è¡¨ -->
        <div id="listContainer" class="space-y-2"></div>
        
        <!-- ç©ºç‹€æ…‹ -->
        <div id="emptyState" class="hidden flex-col items-center py-12 text-slate-300">
            <svg class="w-16 h-16 mb-3 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
            <p class="font-medium">è³¼ç‰©æ¸…å–®æ˜¯ç©ºçš„</p>
            <p class="text-xs mt-1 opacity-70">é–‹å§‹æƒææˆ–è¼¸å…¥åƒ¹æ ¼å§ï¼</p>
        </div>
    </div>

    <!-- 1. è¨­å®šå½ˆçª— -->
    <div id="modalSettings" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden modal-enter">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    è¨­å®š
                </h3>
                <button onclick="document.getElementById('modalSettings').classList.add('hidden')" class="btn-close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">æ¶ˆè²»å¹£åˆ¥</label>
                        <select id="selBase" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">æ›ç®—å¹£åˆ¥</label>
                        <select id="selTarget" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <label class="block text-xs font-bold text-slate-400 mb-1">ç•¶å‰åŒ¯ç‡</label>
                    <div class="flex gap-2">
                        <input type="number" id="inpRate" step="0.0001" class="flex-1 border border-slate-200 rounded-lg p-2 text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00">
                        <button id="btnFetchRate" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-bold hover:bg-blue-200 transition-colors">ç·šä¸Šæ›´æ–°</button>
                    </div>
                </div>
                <div class="pt-2 border-t border-slate-100">
                    <p class="text-xs text-slate-400 mb-2">å¸³è™Ÿç‹€æ…‹</p>
                    <div id="loginSection">
                        <button id="btnLoginGoogle" class="w-full py-2.5 bg-white border border-slate-300 rounded-lg text-slate-600 text-sm font-bold flex items-center justify-center gap-2 hover:bg-slate-50">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4">
                            Google ç™»å…¥ (é€£çµ/åˆ‡æ›)
                        </button>
                        <p class="text-[10px] text-slate-400 mt-2 text-center">åƒ… jingsyuan@gmail.com æ“æœ‰ç®¡ç†æ¬Šé™</p>
                    </div>
                    <div id="userInfoSection" class="hidden text-center">
                        <p class="text-sm font-bold text-slate-700" id="userEmailDisplay"></p>
                        <p class="text-[10px] text-green-600 bg-green-50 inline-block px-2 py-0.5 rounded mt-1 border border-green-100">è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯</p>
                        <button id="btnLogout" class="text-xs text-red-500 hover:underline mt-3 block w-full">ç™»å‡º (åˆ‡æ›å›è¨ªå®¢æ¨¡å¼)</button>
                    </div>
                </div>
                <button onclick="document.getElementById('modalSettings').classList.add('hidden')" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold mt-2">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- 2. åº«å­˜ç®¡ç†å½ˆçª— -->
    <div id="modalDb" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm h-[80vh] flex flex-col shadow-2xl modal-enter">
            <div class="p-4 border-b border-gray-100 flex flex-col gap-2 bg-indigo-600 text-white rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold flex items-center gap-2">å…¬å…±å•†å“åº«å­˜</h3>
                    <button onclick="document.getElementById('modalDb').classList.add('hidden')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <input type="text" id="inpDbSearch" placeholder="ğŸ” å¿«é€Ÿæœå°‹æ¢ç¢¼æˆ–å“å..." class="w-full px-3 py-2 text-sm text-slate-800 rounded-lg focus:outline-none" oninput="filterDbList(this.value)">
            </div>
            <div class="p-2 bg-indigo-50 text-indigo-800 text-xs font-bold text-center border-b border-indigo-100" id="adminNotice"></div>
            <div class="p-4 overflow-y-auto flex-1 space-y-2" id="dbListContainer"></div>
        </div>
    </div>

    <!-- 3. æƒæå™¨ Modal -->
    <div id="modalScan" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <button id="btnCloseScan" class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 p-2 rounded-full backdrop-blur-sm z-50 text-white transition-colors">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div class="text-white mb-4 text-lg font-bold">æƒæå•†å“æ¢ç¢¼</div>
        <div id="reader" class="w-full max-w-sm bg-black rounded-xl overflow-hidden border border-gray-700 shadow-2xl"></div>
    </div>

    <!-- 4. åŒ¯å‡º/åˆ†äº«/å‚™ä»½ Modal -->
    <div id="modalExport" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-xl flex flex-col max-h-[85vh] modal-enter">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">åŒ¯å‡ºèˆ‡å‚™ä»½</h3>
                <button onclick="document.getElementById('modalExport').classList.add('hidden')" class="btn-close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="p-5 pb-0">
                <!-- æª”æ¡ˆæ ¼å¼é¸å–® -->
                <div class="space-y-3 mb-4">
                    <div class="flex items-center justify-between p-3 border rounded-xl hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">ğŸ–¼ï¸</span>
                            <span class="text-sm font-bold text-slate-700">åœ–ç‰‡ (PNG)</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="doExport('png')" class="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold border hover:bg-slate-200">ğŸ’¾ å„²å­˜</button>
                            <button onclick="doShareFile('png')" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200">ğŸ“¤ åˆ†äº«</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-3 border rounded-xl hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">ğŸ“Š</span>
                            <span class="text-sm font-bold text-slate-700">è¡¨æ ¼ (Excel)</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="doExport('xlsx')" class="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold border hover:bg-slate-200">ğŸ’¾ å„²å­˜</button>
                            <button onclick="doShareFile('xlsx')" class="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-xs font-bold hover:bg-green-200">ğŸ“¤ åˆ†äº«</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-3 border rounded-xl hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">ğŸ“„</span>
                            <span class="text-sm font-bold text-slate-700">æ–‡ä»¶ (PDF)</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="doExport('pdf')" class="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold border hover:bg-slate-200">ğŸ’¾ å„²å­˜</button>
                            <button onclick="doShareFile('pdf')" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-xs font-bold hover:bg-red-200">ğŸ“¤ åˆ†äº«</button>
                        </div>
                    </div>
                </div>
                
                <button onclick="doShareText()" class="w-full p-3 border rounded-xl hover:bg-blue-50 text-blue-700 font-bold flex items-center justify-center gap-2 mb-4 text-sm transition-colors">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                    åƒ…è¤‡è£½/åˆ†äº«æ–‡å­—å…§å®¹
                </button>

                <div class="border-t border-slate-100 my-2 pt-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-slate-500 flex items-center gap-1">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            é›²ç«¯å‚™ä»½ (<span id="backupUserType">--</span>)
                        </span>
                        <button onclick="createBackup()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 font-bold flex items-center gap-1">
                            <span>+</span> ç«‹å³å‚™ä»½
                        </button>
                    </div>
                </div>
            </div>

            <!-- Backup List -->
            <div class="overflow-y-auto flex-1 px-5 pb-5 space-y-2" id="backupListContainer"></div>
        </div>
    </div>

    <!-- 5. ç¢ºèªèˆ‡æç¤º UI -->
    <div id="modalConfirm" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl modal-enter">
            <h3 id="confirmTitle" class="text-xl font-bold text-slate-800 mb-2 text-center">ç¢ºèªï¼Ÿ</h3>
            <p id="confirmMsg" class="text-sm text-slate-500 mb-6 text-center">...</p>
            <div class="grid grid-cols-2 gap-3">
                <button id="btnConfirmCancel" class="py-3 px-4 rounded-xl bg-slate-100 font-bold text-slate-600 hover:bg-slate-200">å–æ¶ˆ</button>
                <button id="btnConfirmOk" class="py-3 px-4 rounded-xl bg-red-600 font-bold text-white shadow-lg hover:bg-red-700">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <div id="toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-[70] opacity-0 transition-opacity whitespace-nowrap"></div>

    <!-- Hidden Receipt Container -->
    <div id="exportReceipt">
        <div style="text-align: center; border-bottom: 2px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px;">
            <h2 style="color: #2563eb; margin:0; font-size:24px;">è³¼ç‰©æ¸…å–®</h2>
            <p id="receiptDate" style="color:#666; font-size:12px; margin:5px 0 0 0;"></p>
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="border-bottom: 2px solid #333;"><th style="text-align:left; padding:5px">å“å</th><th style="text-align:right">åƒ¹æ ¼</th><th style="text-align:right">ç´„</th></tr>
            <tbody id="receiptItems"></tbody>
            <tr style="border-top: 2px solid #333;"><td style="padding-top:10px; font-weight:bold">ç¸½è¨ˆ</td><td style="text-align:right; padding-top:10px" id="receiptTotalBase"></td><td style="text-align:right; padding-top:10px; color:#2563eb; font-weight:bold" id="receiptTotalTarget"></td></tr>
        </table>
    </div>

    <script>
        const ADMIN_EMAIL = 'jingsyuan@gmail.com';
        const CURRENCIES = { 'TWD': 'æ–°å°å¹£', 'JPY': 'æ—¥åœ“', 'USD': 'ç¾é‡‘', 'EUR': 'æ­å…ƒ', 'KRW': 'éŸ“å…ƒ', 'CNY': 'äººæ°‘å¹£', 'HKD': 'æ¸¯å¹£', 'THB': 'æ³°éŠ–', 'SGD': 'æ–°å¹£', 'MYR': 'é¦¬å¹£' };
        
        const firebaseConfig = {
            apiKey: "AIzaSyBCpjQ9W336gYM8fPtZPcy2I5tceEQrsBA",
            authDomain: "shopping-ceef3.firebaseapp.com",
            projectId: "shopping-ceef3",
            storageBucket: "shopping-ceef3.firebasestorage.app",
            messagingSenderId: "928963463458",
            appId: "1:928963463458:web:001d86393d780db851fd7b",
            measurementId: "G-KR9GS69ZPN"
        };

        let dbMode = 'local';
        let currentUser = null;
        let currentBarcode = null;
        let items = [];
        let onConfirmAction = null;
        let isProcessingScan = false;
        let settings = JSON.parse(localStorage.getItem('exSettings')) || { base: 'JPY', target: 'TWD', rate: 0.215 };
        let html5QrCode = null;

        // --- Init ---
        (async function init() {
            initCurrencySelects();
            updateSettingsUI();
            bindEvents();
            try {
                firebase.initializeApp(firebaseConfig);
                firebase.auth().onAuthStateChanged(user => {
                    if (user) handleLoginSuccess(user);
                    else firebase.auth().signInAnonymously();
                });
            } catch (e) {
                dbMode = 'local'; items = JSON.parse(localStorage.getItem('localItems')) || []; renderList();
            }
        })();

        function handleLoginSuccess(user) {
            currentUser = user; dbMode = 'cloud';
            document.getElementById('statusBadge').textContent = 'ğŸŸ¢ é›²ç«¯é€£ç·š';
            document.getElementById('statusBadge').className = 'text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded opacity-80';
            document.getElementById('userBadge').classList.remove('hidden');
            
            const isAdmin = user.email === ADMIN_EMAIL;
            const badge = document.getElementById('userBadge');
            const typeStr = isAdmin ? "ç®¡ç†å“¡" : (user.isAnonymous ? "è¨ªå®¢" : "ä¸€èˆ¬æœƒå“¡");
            
            if (isAdmin) { badge.textContent = "ç®¡ç†è€…"; badge.className = "text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold border border-red-200"; }
            else if (user.isAnonymous) { badge.textContent = `è¨ªå®¢ (${user.uid.slice(0,4)})`; badge.className = "text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded"; }
            else { badge.textContent = "å·²ç™»å…¥"; badge.className = "text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded"; }

            document.getElementById('backupUserType').textContent = typeStr;
            document.getElementById('loginSection').classList.toggle('hidden', !user.isAnonymous);
            document.getElementById('userInfoSection').classList.toggle('hidden', user.isAnonymous);
            if(!user.isAnonymous) document.getElementById('userEmailDisplay').textContent = user.email;

            // [FIX] Ensure we map the document ID correctly so deletions work!
            firebase.firestore().collection('users').doc(user.uid).collection('shopping_list').orderBy('timestamp', 'desc').onSnapshot(snap => {
                items = snap.docs.map(d => ({ ...d.data(), id: d.id })); 
                renderList();
            });
        }

        // --- Logic ---
        async function getExportBlob(type) {
            const dateStr = new Date().toLocaleDateString().replace(/\//g, '-');
            const filename = `ShoppingList_${dateStr}`;
            
            document.getElementById('receiptDate').textContent = new Date().toLocaleString();
            document.getElementById('receiptTotalBase').textContent = document.getElementById('dispTotal').textContent;
            document.getElementById('receiptTotalTarget').textContent = document.getElementById('dispConverted').textContent;
            document.getElementById('receiptItems').innerHTML = items.map(i => `<tr><td style="padding:5px">${i.name}</td><td style="text-align:right">${i.price}</td><td style="text-align:right">${Math.round(i.price * settings.rate)}</td></tr>`).join('');
            
            const el = document.getElementById('exportReceipt');

            if (type === 'png') {
                const canvas = await html2canvas(el, { scale: 2 });
                return new Promise(resolve => canvas.toBlob(blob => resolve({ blob, filename: filename+'.png', mime: 'image/png' })));
            } else if (type === 'xlsx') {
                const ws = XLSX.utils.json_to_sheet(items.map(i => ({ 'å“å': i.name, 'åƒ¹æ ¼': i.price, 'ç´„': Math.round(i.price * settings.rate) })));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "æ¸…å–®");
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                return { blob: new Blob([wbout], { type: 'application/octet-stream' }), filename: filename+'.xlsx', mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' };
            } else if (type === 'pdf') {
                const canvas = await html2canvas(el, { scale: 2 });
                const pdf = new window.jspdf.jsPDF();
                const img = canvas.toDataURL('image/png');
                const props = pdf.getImageProperties(img);
                const h = (props.height * pdf.internal.pageSize.getWidth()) / props.width;
                pdf.addImage(img, 'PNG', 0, 10, pdf.internal.pageSize.getWidth(), h);
                return { blob: pdf.output('blob'), filename: filename+'.pdf', mime: 'application/pdf' };
            }
        }

        async function doExport(type) {
            try {
                const { blob, filename } = await getExportBlob(type);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } catch(e) { alert("åŒ¯å‡ºå¤±æ•—: " + e.message); }
        }

        async function doShareFile(type) {
            try {
                const { blob, filename, mime } = await getExportBlob(type);
                const file = new File([blob], filename, { type: mime });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'è³¼ç‰©æ¸…å–®' });
                } else {
                    alert("ç€è¦½å™¨ä¸æ”¯æ´ç›´æ¥åˆ†äº«ï¼Œæ”¹ç‚ºä¸‹è¼‰ã€‚");
                    doExport(type);
                }
            } catch(e) { alert("åˆ†äº«å¤±æ•—: " + e.message); }
        }

        function doShareText() {
            if (items.length === 0) return alert("æ¸…å–®æ˜¯ç©ºçš„");
            const total = items.reduce((sum, i) => sum + (i.price||0), 0);
            let text = `ğŸ›’ è³¼ç‰©æ¸…å–® (${new Date().toLocaleDateString()})\n\n`;
            items.forEach(i => text += `â–«ï¸ ${i.name}: ${i.price}\n`);
            text += `\nğŸ’° ç¸½è¨ˆ: ${total} ${settings.base}`;
            if (navigator.share) navigator.share({ title: 'è³¼ç‰©æ¸…å–®', text: text }).catch(()=>{});
            else { navigator.clipboard.writeText(text); showToast("å·²è¤‡è£½æ–‡å­—"); }
        }

        // --- å‚™ä»½ ---
        async function createBackup() {
            if (dbMode !== 'cloud') return alert("éœ€ç™»å…¥æ‰èƒ½ä½¿ç”¨");
            if (items.length === 0) return alert("ç„¡è³‡æ–™å¯å‚™ä»½");
            const dateStr = new Date().toISOString().replace(/[:.]/g, '-');
            try {
                await firebase.firestore().collection('users').doc(currentUser.uid).collection('backups').doc(dateStr).set({
                    items: items, createdAt: firebase.firestore.FieldValue.serverTimestamp(), displayName: new Date().toLocaleString()
                });
                showToast("å‚™ä»½æˆåŠŸ"); loadBackups();
            } catch(e) { alert("å‚™ä»½å¤±æ•—: " + e.message); }
        }

        async function loadBackups() {
            if (dbMode !== 'cloud') return;
            const container = document.getElementById('backupListContainer');
            container.innerHTML = '<div class="text-center py-4 text-xs text-slate-400">è¼‰å…¥ä¸­...</div>';
            try {
                const snap = await firebase.firestore().collection('users').doc(currentUser.uid).collection('backups').orderBy('createdAt', 'desc').limit(10).get();
                if (snap.empty) { container.innerHTML = '<div class="text-center py-4 text-xs text-slate-400">å°šç„¡å‚™ä»½</div>'; return; }
                container.innerHTML = snap.docs.map(doc => {
                    const data = doc.data();
                    return `<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <div><div class="text-sm font-bold text-slate-700">${data.displayName}</div><div class="text-[10px] text-slate-400">${(data.items||[]).length} é …ç›®</div></div>
                        <button onclick="restoreBackup('${doc.id}')" class="text-xs bg-white border border-slate-200 text-blue-600 px-3 py-1.5 rounded font-bold hover:bg-blue-50">é‚„åŸ</button>
                    </div>`;
                }).join('');
            } catch(e) { container.innerHTML = '<div class="text-center py-4 text-xs text-red-400">è¼‰å…¥å¤±æ•—</div>'; }
        }

        window.restoreBackup = (id) => {
            showConfirm("é‚„åŸ", "é€™å°‡è¦†è“‹ç•¶å‰æ¸…å–®ï¼Œç¢ºå®šï¼Ÿ", async () => {
                try {
                    const doc = await firebase.firestore().collection('users').doc(currentUser.uid).collection('backups').doc(id).get();
                    if(!doc.exists) return;
                    const backupData = doc.data().items || [];
                    const batch = firebase.firestore().batch();
                    const ref = firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list');
                    const snap = await ref.get();
                    snap.docs.forEach(d => batch.delete(d.ref));
                    
                    backupData.forEach(item => {
                        const { id, ...cleanItem } = item; 
                        const newRef = ref.doc();
                        batch.set(newRef, cleanItem);
                    });
                    
                    await batch.commit();
                    showToast("é‚„åŸæˆåŠŸ");
                    document.getElementById('modalExport').classList.add('hidden');
                } catch(e) { alert("é‚„åŸå¤±æ•—: " + e.message); }
            });
        };

        // --- Misc ---
        function initCurrencySelects() {
            const opts = Object.entries(CURRENCIES).map(([k, v]) => `<option value="${k}">${v}</option>`).join('');
            document.getElementById('selBase').innerHTML = opts; document.getElementById('selTarget').innerHTML = opts;
        }
        function updateSettingsUI() {
            document.getElementById('selBase').value = settings.base; document.getElementById('selTarget').value = settings.target;
            document.getElementById('inpRate').value = settings.rate;
            document.getElementById('lblBase').textContent = settings.base; document.getElementById('lblTarget').textContent = settings.target;
            document.getElementById('lblBaseSet').textContent = settings.base; document.getElementById('lblTargetSet').textContent = settings.target;
            document.getElementById('inpPrice').placeholder = `åƒ¹æ ¼ (${settings.base})`;
            renderList();
        }
        function showToast(msg) { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('toast-show'); setTimeout(() => el.classList.remove('toast-show'), 2500); }
        function showConfirm(t, m, cb) { document.getElementById('confirmTitle').textContent = t; document.getElementById('confirmMsg').textContent = m; document.getElementById('modalConfirm').classList.remove('hidden'); onConfirmAction = cb; }
        
        function bindEvents() {
            document.getElementById('btnSettings').onclick = () => document.getElementById('modalSettings').classList.remove('hidden');
            document.getElementById('btnExport').onclick = () => { document.getElementById('modalExport').classList.remove('hidden'); if(dbMode==='cloud') loadBackups(); };
            document.getElementById('btnDb').onclick = openDbManager;
            document.getElementById('btnConfirmCancel').onclick = () => { document.getElementById('modalConfirm').classList.add('hidden'); onConfirmAction = null; };
            document.getElementById('btnConfirmOk').onclick = () => { if(onConfirmAction) onConfirmAction(); document.getElementById('modalConfirm').classList.add('hidden'); onConfirmAction = null; };
            document.getElementById('btnLoginGoogle').onclick = async () => { try { await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()); showToast("ç™»å…¥æˆåŠŸ"); } catch(e) { alert("ç™»å…¥å¤±æ•—: "+e.message); }};
            
            // Logout with Guest Warning
            document.getElementById('btnLogout').onclick = () => {
                if (currentUser && currentUser.isAnonymous) {
                    showConfirm("ç¢ºå®šç™»å‡ºè¨ªå®¢ï¼Ÿ", "è­¦å‘Šï¼šè¨ªå®¢è³‡æ–™å„²å­˜åœ¨æ­¤ç€è¦½å™¨ ID ä¸Šã€‚è‹¥æ‚¨ç™»å‡ºï¼Œå¯èƒ½ç„¡æ³•å†å­˜å–ç›®å‰çš„è³¼ç‰©æ¸…å–®ï¼Œé™¤éæ‚¨ä¹‹å¾Œå†è¢«é…ç™¼ç›¸åŒçš„ IDã€‚", () => {
                        firebase.auth().signOut().then(() => window.location.reload());
                    });
                } else {
                    firebase.auth().signOut().then(() => window.location.reload());
                }
            };
            
            document.getElementById('btnClear').onclick = () => showConfirm("æ¸…ç©º", "ç¢ºå®šåˆªé™¤æ‰€æœ‰é …ç›®ï¼Ÿ", async () => {
                if(dbMode==='cloud') { const b = firebase.firestore().batch(); const r = firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list'); const s = await r.get(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit(); }
                else { items=[]; localStorage.setItem('localItems', '[]'); renderList(); }
                showToast("å·²æ¸…ç©º");
            });

            document.getElementById('formItem').onsubmit = async (e) => {
                e.preventDefault();
                const n = document.getElementById('inpName').value.trim(); const p = parseFloat(document.getElementById('inpPrice').value);
                if(!p && p!==0) return;
                const item = { name: n||'(æœªå‘½å)', price: p, barcode: currentBarcode, timestamp: Date.now() };
                if(dbMode==='cloud') {
                    await firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list').add({ ...item, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    if(currentBarcode && n) firebase.firestore().collection('products').doc(currentBarcode).set({ name: n, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), contributor: currentUser.uid }, {merge:true});
                } else { item.id = Date.now().toString(); items.unshift(item); localStorage.setItem('localItems', JSON.stringify(items)); renderList(); }
                document.getElementById('inpName').value=''; document.getElementById('inpPrice').value=''; currentBarcode=null; document.getElementById('scanHint').classList.add('hidden'); showToast("å·²åŠ å…¥");
            };

            ['selBase', 'selTarget'].forEach(id => document.getElementById(id).onchange = () => {
                settings.base = document.getElementById('selBase').value; settings.target = document.getElementById('selTarget').value;
                localStorage.setItem('exSettings', JSON.stringify(settings)); updateSettingsUI(); document.getElementById('btnFetchRate').click();
            });
            document.getElementById('inpRate').oninput = (e) => { settings.rate = parseFloat(e.target.value)||0; localStorage.setItem('exSettings', JSON.stringify(settings)); renderList(); };
            document.getElementById('btnFetchRate').onclick = async () => {
                const btn=document.getElementById('btnFetchRate'); btn.textContent="...";
                try { const res=await fetch(`https://api.exchangerate-api.com/v4/latest/${settings.base}`); const d=await res.json(); if(d.rates[settings.target]){ settings.rate=d.rates[settings.target]; localStorage.setItem('exSettings', JSON.stringify(settings)); updateSettingsUI(); showToast("æ›´æ–°æˆåŠŸ"); } } catch(e){ showToast("é€£ç·šå¤±æ•—"); } btn.textContent="ç·šä¸Šæ›´æ–°";
            };
            
            // Scanner Fix: Anti-flicker
            document.getElementById('btnScan').onclick = () => { 
                document.getElementById('modalScan').classList.remove('hidden'); 
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async txt => {
                    if(isProcessingScan) return;
                    isProcessingScan = true;
                    try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e){}
                    document.getElementById('modalScan').classList.add('hidden');
                    
                    currentBarcode = txt; 
                    document.getElementById('inpName').value="æŸ¥è©¢ä¸­..."; 
                    document.getElementById('scanHint').classList.remove('hidden'); 
                    document.getElementById('lblSource').textContent="...";
                    
                    let name="", src="æ–°ç™¼ç¾";
                    try {
                        if(dbMode==='cloud') { const d=await firebase.firestore().collection('products').doc(txt).get(); if(d.exists){ name=d.data().name; src="è³‡æ–™åº«"; } }
                        if(!name) { const r=await fetch(`https://world.openfoodfacts.org/api/v0/product/${txt}.json`); const d=await r.json(); if(d.status===1) { name=d.product.product_name_zh||d.product.product_name; src="ç¶²è·¯ API"; } }
                    } catch(e){}
                    
                    document.getElementById('inpName').value=name; 
                    document.getElementById('inpName').focus(); 
                    document.getElementById('lblSource').textContent=src;
                    
                    setTimeout(() => { isProcessingScan = false; }, 1000);
                }).catch(()=>{}); 
            };
            document.getElementById('btnCloseScan').onclick = () => { 
                if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()).catch(()=>{});
                document.getElementById('modalScan').classList.add('hidden'); 
            };
            document.getElementById('btnClearScan').onclick = () => { currentBarcode=null; document.getElementById('scanHint').classList.add('hidden'); document.getElementById('inpName').value=''; };

            // Content Editable Listener
            document.getElementById('listContainer').addEventListener('focusout', async (e) => {
                const target = e.target;
                if (!target.hasAttribute('contenteditable')) return;
                
                const id = target.dataset.id;
                const field = target.dataset.field;
                let val = target.textContent.trim();
                
                if (field === 'price') {
                    val = parseFloat(val.replace(/,/g, ''));
                    if (isNaN(val)) val = 0;
                }
                
                if (dbMode === 'cloud') {
                    await firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list').doc(id).update({ [field]: val });
                } else {
                    const item = items.find(i => i.id === id);
                    if (item) { item[field] = val; saveLocal(); renderList(); }
                }
            });
            
            // Prevent Enter newlines
            document.getElementById('listContainer').addEventListener('keydown', (e) => {
                if (e.target.hasAttribute('contenteditable') && e.key === 'Enter') {
                    e.preventDefault(); e.target.blur();
                }
            });
        }

        window.deleteItem = (id) => showConfirm("åˆªé™¤", "ç¢ºå®šç§»é™¤ï¼Ÿ", async () => {
            if(dbMode==='cloud') await firebase.firestore().collection('users').doc(currentUser.uid).collection('shopping_list').doc(String(id)).delete();
            else { items=items.filter(i=>String(i.id)!==String(id)); localStorage.setItem('localItems', JSON.stringify(items)); renderList(); }
            showToast("å·²åˆªé™¤");
        });

        window.filterDbList = (v) => { const term=v.toLowerCase(); document.querySelectorAll('#dbListContainer > div').forEach(r => r.style.display = r.innerText.toLowerCase().includes(term)?'flex':'none'); };
        
        async function openDbManager() {
            document.getElementById('modalDb').classList.remove('hidden');
            if(dbMode!=='cloud') return document.getElementById('dbListContainer').innerHTML='<div class="text-center py-10 text-slate-400">éœ€é€£ç·š</div>';
            const isAdmin = currentUser&&currentUser.email===ADMIN_EMAIL;
            document.getElementById('adminNotice').textContent = isAdmin ? "ğŸ‘‘ ç®¡ç†å“¡æ¨¡å¼" : "ğŸ‘€ è¨ªå®¢æ¨¡å¼ (å”¯è®€)";
            document.getElementById('dbListContainer').innerHTML='<div class="text-center py-10 text-slate-400">è¼‰å…¥ä¸­...</div>';
            try {
                const snap = await firebase.firestore().collection('products').orderBy('updatedAt', 'desc').limit(100).get();
                document.getElementById('dbListContainer').innerHTML = snap.empty ? '<div class="text-center py-10 text-slate-400">ç©º</div>' : snap.docs.map(d => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 mb-2">
                        <div class="overflow-hidden mr-3"><div class="font-bold text-sm text-slate-700 truncate">${d.data().name}</div><div class="text-[10px] font-mono text-indigo-400">${d.id}</div></div>
                        ${isAdmin ? `<button onclick="delPub('${d.id}')" class="text-red-500 text-xs border border-red-200 p-1 rounded">åˆª</button>` : ''}
                    </div>`).join('');
            } catch(e) { document.getElementById('dbListContainer').innerHTML='<div class="text-center text-red-400">å¤±æ•—</div>'; }
        }
        window.delPub = (id) => showConfirm("åˆªé™¤", "ç¢ºå®šåˆªé™¤æ­¤å…¬å…±æ¢ç¢¼ï¼Ÿ", async () => { await firebase.firestore().collection('products').doc(id).delete(); openDbManager(); showToast("å·²åˆªé™¤"); });
        
        function renderList() {
            const total = items.reduce((s,i)=>s+(i.price||0),0);
            document.getElementById('dispTotal').textContent=total.toLocaleString(); document.getElementById('dispConverted').textContent='$'+Math.round(total*settings.rate).toLocaleString(); document.getElementById('dispRate').textContent=settings.rate;
            document.getElementById('listContainer').innerHTML = items.length===0 ? '' : items.map(i=>`
                <div class="flex items-center justify-between px-4 py-3 bg-white rounded-xl border border-slate-100 shadow-sm mb-2">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <div class="flex flex-col items-end min-w-[60px]">
                            <div class="text-lg font-bold text-slate-800 tracking-tight" contenteditable="true" data-id="${i.id}" data-field="price">${i.price.toLocaleString()}</div>
                            <div class="text-[11px] text-slate-400">â‰ˆ ${Math.round(i.price*settings.rate).toLocaleString()}</div>
                        </div>
                        <div class="h-8 w-px bg-slate-100"></div>
                        <div class="flex-1 overflow-hidden">
                            <div class="text-sm font-medium text-slate-700 truncate" contenteditable="true" data-id="${i.id}" data-field="name">${i.name}</div>
                            ${i.barcode?`<div class="text-[10px] font-mono text-slate-400 bg-slate-50 inline-block px-1.5 py-0.5 rounded border border-slate-100 mt-0.5">${i.barcode}</div>`:''}
                        </div>
                    </div>
                    <button onclick="deleteItem('${i.id}')" class="ml-2 text-slate-300 hover:text-red-500 p-2">âœ•</button>
                </div>`).join('');
            document.getElementById('emptyState').style.display = items.length===0?'flex':'none';
        }
    </script>
</body>
</html>
